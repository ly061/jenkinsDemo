// ä½¿ç”¨é¢„é…ç½®å·¥å…·çš„ç‰ˆæœ¬ - éœ€è¦åœ¨ Jenkins ä¸­é…ç½®å·¥å…·
// é…ç½®æ–¹æ³•ï¼šç³»ç»Ÿç®¡ç† â†’ å…¨å±€å·¥å…·é…ç½® â†’ Maven/JDK å®‰è£…
pipeline {
    agent any
    
    tools {
        // é…ç½® Maven å’Œ JDKï¼ˆæ ¹æ®ä½ çš„Jenkinsä¸­é…ç½®çš„å·¥å…·åç§°è°ƒæ•´ï¼‰
        maven 'Maven-3.9.9'  // ä¿®æ”¹ä¸ºä½ çš„ Maven å·¥å…·åç§°
        jdk 'JDK-17'          // ä¿®æ”¹ä¸ºä½ çš„ JDK å·¥å…·åç§°
    }
    
    options {
        // ä¿ç•™æœ€è¿‘10æ¬¡æ„å»ºçš„æ„å»ºå†å²
        buildDiscarder(logRotator(numToKeepStr: '10'))
        // è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º30åˆ†é’Ÿ
        timeout(time: 30, unit: 'MINUTES')
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo '=== æ£€å‡ºä»£ç  ==='
                    checkout scm
                }
            }
        }
        
        stage('Clean') {
            steps {
                script {
                    echo '=== æ¸…ç†æ„å»ºç›®å½• ==='
                    sh 'mvn clean'
                }
            }
        }
        
        stage('Compile') {
            steps {
                script {
                    echo '=== ç¼–è¯‘é¡¹ç›® ==='
                    sh 'mvn compile test-compile'
                }
            }
        }
        
        stage('Test') {
            steps {
                script {
                    echo '=== è¿è¡Œ TestNG æµ‹è¯• ==='
                    sh 'mvn test'
                }
            }
            post {
                always {
                    // å‘å¸ƒæµ‹è¯•æŠ¥å‘Š
                    publishTestResults testResultsPattern: 'target/surefire-reports/*.xml'
                    
                    // å‘å¸ƒ TestNG HTML æŠ¥å‘Š
                    publishHTML([
                        reportDir: 'target/surefire-reports',
                        reportFiles: 'index.html',
                        reportName: 'TestNG æµ‹è¯•æŠ¥å‘Š',
                        keepAll: true
                    ])
                    
                    // å½’æ¡£æµ‹è¯•æŠ¥å‘Š
                    archiveArtifacts artifacts: 'target/surefire-reports/**/*', fingerprint: true
                }
                success {
                    echo 'âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼'
                }
                failure {
                    echo 'âŒ æµ‹è¯•å¤±è´¥ï¼'
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo '=== æ„å»ºå®Œæˆ ==='
            }
        }
        success {
            echo 'ğŸ‰ Pipeline æ‰§è¡ŒæˆåŠŸï¼'
        }
        failure {
            echo 'ğŸ’¥ Pipeline æ‰§è¡Œå¤±è´¥ï¼'
        }
        unstable {
            echo 'âš ï¸ Pipeline æ‰§è¡Œä¸ç¨³å®šï¼'
        }
    }
}

